<script setup lang="ts">
//Endpoint /planetas/NewPlaneta
import * as z from 'zod'
import type { FormSubmitEvent } from '@nuxt/ui'
import {FetchError} from 'ofetch'
import { selectMenu } from '#build/ui';
const { loggedIn, user, session, fetch, clear, openInPopup } = useUserSession();

const volver = () => navigateTo("/admin");
definePageMeta({ middleware: ['auth'] })

// Consulta principal para pintar el dashboard.
const { data: galaxias, pending, error, refresh } = useFetch('/api/galaxia/get', {
    default: () => []
})

// Transformamos las galaxias para el componente Select
// Nuxt UI espera objetos con 'label' (lo que se ve) y 'value' (lo que se guarda)
const opcionesGalaxias = computed(() => {
  return galaxias.value.map(g => ({
    label: g.nombre,
    value: g.id
  }))
})
const schema = z.object({
  nombre: z.string().min(2,"El nombre es obligatorio"),
  anillos: z.number().optional(),
  satelites: z.number().optional(),
  habitabilidad: z.string(),
  orbita_dias: z.number(),
  galaxiaId: z.number({ required_error: "Debes seleccionar una galaxia" })
})

type Schema = z.output<typeof schema>

const state = reactive<Partial<Schema>>({
  nombre: undefined,
  anillos: undefined,
  satelites: undefined,
  habitabilidad: undefined,
  orbita_dias: undefined,
  galaxiaId:undefined
})

const toast = useToast()
async function onSubmit(event: FormSubmitEvent<Schema>) {
//Hago el insert
  try {
    const nuevoPlaneta = await $fetch('/api/planetas/post', {
      method:'POST',
      body:event.data
    })

    fetch()
    toast.add({ title: 'Success', description: 'The form has been submitted.', color: 'success' })
    navigateTo(`/planetas/detalle/${nuevoPlaneta.id}`)

  } catch (error) {
   
    if(error instanceof FetchError){
      //Error de fetch
      toast.add({ title: 'Error', description: error.data.message, color: 'error' })
    }else{
      //Error no controlado
      toast.add({ title: 'error', description: 'Error en la aplicación. Por favor contacte con el equipo técnico', color: 'error' })

    }
  }
}


</script>


<template>
      <button @click="volver" class="btn-back">← Volver al inicio</button>

       <UForm :schema="schema" :state="state" class="space-y-4" @submit="onSubmit">
        <UFormField label="Nombre" name="nombre">
            <UInput v-model="state.nombre" />
        </UFormField>

        <UFormField label="Número de anillos" name="anillos">
            <UInput v-model="state.anillos" type="number"  />
        </UFormField>

         <UFormField label="Satelites" name="satelites">
            <UInput v-model="state.satelites" type="number"  />
        </UFormField>

         <UFormField label="Habitabilidad" name="habitabilidad">
            <UInput v-model="state.habitabilidad" type="text"  />
        </UFormField>

        <UFormField label="Orbita_dias" name="orbita_dias">
            <UInput v-model="state.orbita_dias" type="number"  />
        </UFormField>

        <UFormField label="Galaxias:" name="galaxias">
            <selectMenu>

            </selectMenu>
        </UFormField>
        <UFormField label="Seleciona una galaxia" name="galaxiaId">
            <!--Le paso un array de objectos que creen con el map. El Uselect busca la propieda label y los muestra el pantall y para el valor con la propieda value del objecto -->
            <USelect v-model="state.galaxiaId" :items="opcionesGalaxias" class="w-48" />
        </UFormField>
       

        <!--Login normal-->
        <UButton type="submit">
        Submit
        </UButton>
  </UForm>
</template>


